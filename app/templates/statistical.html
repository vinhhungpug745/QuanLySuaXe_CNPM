{%extends 'layout/base.html'%}
{% block title %}Xem b√°o c√°o{% endblock %}
<body>
    {%block content%}
        <div class="stats-dashboard-wrapper">
            <div class="dashboard-container">
                <!-- Filter Section -->
                <div class="filter-section">
                    <form class="filter-grid" action="/statistical/create" method="GET">
                        <!-- Ch·ªçn lo·∫°i l·ªçc -->
                        <div class="filter-item">
                            <label class="filter-label">Ch·ªçn ki·ªÉu l·ªçc</label>
                            <select class="filter-select" id="filterType" name="filter_type" onchange="showFilterInput(this.value)" required>
                                <option value="">-- Ch·ªçn ki·ªÉu th·ªëng k√™ --</option>
                                <option value="vehicle">üöó Th·ªëng k√™ theo lo·∫°i xe</option>
                                <option value="time">üìÖ Th·ªëng k√™ doanh thu theo th·ªùi gian</option>
                            </select>
                        </div>
                        <div class="dynamic-inputs" id="dynamicInputs" style="display: none;">
                                <!-- Time Filter Options -->
                                <div id="timeOptions" style="display: none;">
                                    <div class="input-group">
                                        <label class="input-label">Ch·ªçn ki·ªÉu th·ªùi gian</label>
                                        <select class="filter-select" id="timeType" name="time_type" onchange="showDateInput(this.value)">
                                            <option value="">-- Ch·ªçn ki·ªÉu th·ªùi gian --</option>
                                            <option value="day">Theo ng√†y</option>
                                            <option value="month">Theo th√°ng</option>
                                            <option value="range">Theo kho·∫£ng th·ªùi gian</option>
                                        </select>
                                    </div>

                                    <!-- Date Inputs -->
                                    <div id="dateInputs" style="display: none;">
                                        <!-- Single Day -->
                                        <div class="input-group" id="dayInput" style="display: none;">
                                            <label class="input-label">Ch·ªçn ng√†y</label>
                                            <input type="date" class="filter-input" name="date_day" max="{{ maxday }}"/>
                                        </div>

                                        <!-- Month -->
                                        <div class="input-group" id="monthInput" style="display: none;">
                                            <label class="input-label">Ch·ªçn th√°ng</label>
                                            <input type="month" class="filter-input" name="date_month" max="{{maxday[:7]}}"/>
                                        </div>

                                        <!-- Date Range -->
                                        <div class="input-group" id="rangeInput" style="display: none;">
                                            <label class="input-label">T·ª´ ng√†y</label>
                                            <input type="date" class="filter-input" name="date_from" max="{{maxday}}"/>
                                            <label class="input-label" style="margin-top: 8px;">ƒê·∫øn ng√†y</label>
                                            <input type="date" class="filter-input" name="date_to" max="{{maxday}}"/>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        <!-- Ki·ªÉu bi·ªÉu ƒë·ªì -->
                        <div class="filter-item">
                            <label class="filter-label">Ki·ªÉu bi·ªÉu ƒë·ªì</label>
                            <select class="filter-select" id="chartType" name="chart_type" required>
                                <option value="">-- Ch·ªçn bi·ªÉu ƒë·ªì --</option>
                                <option value="pie"> ƒë·ªì tr√≤n</option>
                                <option value="doughnut">Bi·ªÉu ƒë·ªì v√≤ng</option>
                                <option value="line">Bi·ªÉu ƒë·ªì line</option>
                                <option value="bar">Bi·ªÉu ƒë·ªì bar</option>
                                <option value="polarArea">Bi·ªÉu ƒë·ªì khu v·ª±c</option>
                            </select>
                        </div>

                        <!-- Submit Button -->
                        <div class="filter-item" style="display: flex; align-items: flex-end;">
                            <button type="submit" class="submit-button button-statistical">Th·ªëng k√™</button>
                        </div>

                    </form>

                </div>

                <!-- Stats Section -->
                <div class="stats-section">
                    <!-- Stats Cards - 30% -->
                    <div class="stats-cards">
                        <div class="stat-card">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    {%if type == 'vehicle'%}
                                        <tr>
                                            <th>ID</th>
                                            <th>Lo·∫°i xe</th>
                                            <th>S·ªë l∆∞·ª£ng</th>
                                        </tr>
                                    {%else%}
                                        <tr>
                                            <th>Ng√†y</th>
                                            <th>Doanh Thu</th>
                                        </tr>
                                    {%endif%}
                                </thead>
                                <tbody>
                                    {% if type == 'vehicle' %}
                                        {% for r in res %}
                                            <tr>
                                                <td>{{ r[0] }}</td>
                                                <td>{{ r[1] }}</td>
                                                <td>{{ r[2] }}</td>
                                            </tr>
                                        {% endfor %}
                                    {% else %}
                                        {% for r in res %}
                                            <tr>
                                                <td>{{ r[0] }}</td>
                                                <td>{{ "{:,.0f}".format(r[1]).replace(',', '.') }} vnƒë</td>
                                            </tr>
                                        {% endfor %}
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                        {%if type == 'time'%}
                            <div class="stat-card">
                                <div class="stat-label">T·ªïng Doanh Thu</div>
                                <div class="stat-value">{{ "{:,.0f}".format(total).replace(',', '.') }} vnƒë</div>
                            </div>
                        {%else%}
                            <div class="stat-card">
                                <div class="stat-label">T·ªïng S·ªë xe</div>
                                <div class="stat-value">{{total}} chi·∫øc</div>
                            </div>
                        {%endif%}
                    </div>

                    <!-- Chart Area - 70% -->
                    <div class="chart-area">
                        <div class="chart-header">
                            <h2 class="chart-title">Bi·ªÉu ƒë·ªì ph√¢n t√≠ch</h2>
                        </div>
                        <div class="chart-canvas" id="chartCanvas">
                            <div class="chart-placeholder">
                                {%if res%}
                                    <canvas id="myChart"></canvas>
                                {%else%}
                                    <h2 class="chart-title">Bi·ªÉu ƒë·ªì ph√¢n t√≠ch</h2>
                                    <p class="chart-subtitle">Vui l√≤ng ch·ªçn d·ªØ li·ªáu v√† ki·ªÉu bi·ªÉu ƒë·ªì mu·ªën xem</p>
                                {%endif%}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    <script>
        let labels = [];
        let data = [];
        let tilte = '';
        let type = '{{ chart_type }}';

        console.log(type);

        {% if type == 'vehicle' %}
            tilte = 'Th·ªëng k√™ theo xe'
            {% for r in res %}
                labels.push('{{ r[1] }}')
                data.push({{ r[2] }})
            {% endfor %}
        {% else %}
            tilte = 'Th·ªëng k√™ doanh thu theo th·ªùi gian'
            {% for r in res %}
                labels.push('{{ r[0] }}')
                data.push({{ r[1] }})
            {% endfor %}
        {% endif %}

        window.onload = function() {
            drawChart(labels, data, tilte, type);
        }
        function showFilterInput(filterType) {
            const dynamicContainer = document.getElementById('dynamicInputs');
            const timeOptions = document.getElementById('timeOptions');
            const dateInputs = document.getElementById('dateInputs');

            // Hide all first
            dynamicContainer.style.display = 'none';
            timeOptions.style.display = 'none';
            dateInputs.style.display = 'none';

            // Reset time type select
            document.getElementById('timeType').value = '';

            // Show based on selection
            if (filterType === 'vehicle') {
                dynamicContainer.style.display = 'block';
            } else if (filterType === 'time') {
                dynamicContainer.style.display = 'block';
                timeOptions.style.display = 'block';
            }
        }

        function showDateInput(timeType) {
            const dateInputs = document.getElementById('dateInputs');
            const dayInput = document.getElementById('dayInput');
            const monthInput = document.getElementById('monthInput');
            const rangeInput = document.getElementById('rangeInput');

            // Hide all first
            dayInput.style.display = 'none';
            monthInput.style.display = 'none';
            rangeInput.style.display = 'none';
            dateInputs.style.display = 'none';

            // Show based on selection
            if (timeType === 'day') {
                dateInputs.style.display = 'block';
                dayInput.style.display = 'block';
            } else if (timeType === 'month') {
                dateInputs.style.display = 'block';
                monthInput.style.display = 'block';
            } else if (timeType === 'range') {
                dateInputs.style.display = 'block';
                rangeInput.style.display = 'block';
            }
        }
    </script>
    {%endblock%}

</body>
